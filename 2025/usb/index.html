<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>usb学习记录</title>

    <link rel="stylesheet" href="../../main.css">
    <!-- code -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
</head>
<body>
    <style>
        code {
            background-color: #eee;
        }
        pre {
            background-color: #eee;
        }
    </style>
    <div>
        <a href="../../index.html">back</a>
        <b>usb学习记录</b>
        <hr>
    </div>
    <section>
        <h3 class="section-title">修改历史</h3>
        <div class="section_content">
            <table border="1">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>2026-1-10</td>
                        <td>添加了HID的内容</td>
                    </tr>
                    <tr>
                        <td>2025-12-17</td>
                        <td>首次创建</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>
    <section>
        <h3 class="section-title">bus hound</h3>
        <div class="section_content">
            <a href="https://www.cnblogs.com/xuejiangqiang/p/16582396.html">more</a>
            <table border="1">
                <thead>
                    <tr>
                        <th>Error</th>
                        <th>What</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>babble detected</td>
                        <td>TX寄存器的长度比描述符里的端点maxpacket大</td>
                    </tr>
                    <tr>
                        <td>xact error</td>
                        <td>硬件usb外设配置有问题</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>
    <section>
        <h3 class="section-title">UAC2</h3>
        <div class="section_content">
            <p>强烈推荐对着<a href="https://www.usb.org/sites/default/files/Audio2_with_Errata_and_ECN_through_Apr_2_2025.pdf">官方手册</a>食用</p>
            <hr>
        </div>
        <div class="section_content">
            <h3>AudioControl接口请求</h3>
            <p>接口编号在<code>wIndex & 0xff</code>，实体编号在<code>wIndex >> 8</code>，请求操作在<code>bRequest</code></p>
            <table border="1">
                <thead>
                    <tr>
                        <!-- <th>GET/SET(bmRequestType & 0x80)</th> -->
                        <th>GET/SET</th>
                        <th>bRequest</th>
                        <th>实体类型</th>
                        <th>wValue高字节</th>
                        <th>wValue低字节</th>
                        <th>做什么</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- clock page 97 -->
                    <tr>
                        <td>GET</td>
                        <td rowspan="2">CUR(1)</td>
                        <td rowspan="4">Clock(97页)</td>
                        <td rowspan="2">CS_SAM_FREQ_CONTROL(0x01)</td>
                        <td rowspan="4"></td>
                        <td>传uint32的采样率</td>
                    </tr>
                    <tr>
                        <td>SET</td>
                        <td>设置uint32的采样率</td>
                    </tr>
                    <tr>
                        <td>GET</td>
                        <td>RANGE(2)</td>
                        <td>CS_SAM_FREQ_CONTROL(0x01)</td>
                        <td>传采样率表，格式
                            <code>
                                uint16 count,
                                [{uint32 min=fs, uint32 max=fs, uint32 res=0}
                                ...]
                            </code>
                            min max一样，step必须是0
                        </td>
                    </tr>
                    <tr>
                        <td>GET</td>
                        <td>CUR(1)</td>
                        <td>CS_CLOCK_VALID_CONTROL(0x02)</td>
                        <td>传uint8，时钟有没有稳定</td>
                    </tr>
                    <!-- FeatureUnit page 102 -->
                    <tr>
                        <td>GET</td>
                        <td rowspan="2">CUR(1)</td>
                        <td rowspan="5">FeatureUnit(102页)</td>
                        <td rowspan="2">FU_MUTE_CONTROL(0x01)</td>
                        <td rowspan="5">通道编号</td>
                        <td>传uint8，是否静音</td>
                    </tr>
                    <tr>
                        <td>SET</td>
                        <td>设置uint8，是否静音，1是静音</td>
                    </tr>
                    <tr>
                        <td>GET</td>
                        <td rowspan="2">CUR(1)</td>
                        <td rowspan="3">FU_VOLUME_CONTROL(0x02)</td>
                        <td>传uint16，音量</td>
                    </tr>
                    <tr>
                        <td>SET</td>
                        <td>设置uint16,音量，0x8000是静音</td>
                    </tr>
                    <tr>
                        <td>GET</td>
                        <td rowspan="2">RANGE(2)</td>
                        <td>传<code>uint16 count [uint16 min, uint16 max, uint16 step]</code>。0x8001(-127.9961dB)~0x7fff(127.9961dB),step从0x00001(1/256dB)~0x7fff(127.9961dB)</td>
                    </tr>
                </tbody>
            </table>
            <hr>
        </div>
        <div class="section_content">
            <h3>AudioStream接口请求</h3>
            <hr>
        </div>
        <div class="section_content">
            <h3>反馈速率转换</h3>
            <p>省流：把你的采样率（每秒多少个样本）转换为（每帧/微帧）多少个样本。</p>
            <p>高速：4(unused) 12(整数部分).13(小数部分) 3(optional)</p>
            <pre>
                <code>
void Hs(uint32_t sample_rate, uint8_t buffer[4]) {
    // oh, so easy with FPU
    // float a = sample_rate / 8000;
    // uint16_t intergal = a;
    // uint16_t frac = (a - intergal) * 65536;
    // buffer[0] = frac & 0xff;
    // buffer[1] = frac >> 8;
    // buffer[2] = intergal & 0xff;
    // buffer[3] = intergal >> 8;

    uint32_t intergal = sample_rate / 8000;
    uint32_t frac = (sample_rate % 8000) * 65536 / 8000;
    uint32_t rate = (intergal &lt;&lt; 16) | (frac & 0xffff);
    buffer[0] = rate & 0xff;
    buffer[1] = rate >> 8;
    buffer[2] = rate >> 16;
    buffer[3] = rate >> 24;
}
                </code>
            </pre>
            <p>全速：10(整数部分).10(小数部分) 4(optional)</p>
            <pre>
                <code>
void Fs(uint32_t sample_rate, uint8_t buffer[3]) {
    uint32_t intergal = sample_rate / 1000;
    uint32_t frac = (sample_rate % 1000) * (1 &lt;&lt 14) / 1000;
    uint32_t rate = (intergal &lt;&lt; 10) | (frac & 0x3fff);
    buffer[0] = rate & 0xff;
    buffer[1] = rate >> 8;
    buffer[2] = rate >> 16;
}
                </code>
            </pre>
            <p>或许你想要<a href="https://www.usb.org/document-library/usb-20-specification">原文</a>，usb2.0规范102页</p>
            <pre>
    In summary, for full-speed endpoints, the Ff
 value shall be encoded in an unsigned 10.10 (K=10) format
which fits into three bytes. Because the maximum integer value is fixed to 1,023, the 10.10 number will be
left-justified in the 24 bits, so that it has a 10.14 format. Only the first ten bits behind the binary point are
required. The lower four bits may be optionally used to extend the precision of Ff
, otherwise, they shall be
reported as zero. For high-speed endpoints, the Ff
 value shall be encoded in an unsigned 12.13 (K=13)
format which fits into four bytes. The value shall be aligned into these four bytes so that the binary point is
located between the second and the third byte so that it has a 16.16 format. The most significant four bits
shall be reported zero. Only the first 13 bits behind the binary point are required. The lower three bits may
be optionally used to extend the precision of Ff
, otherwise, they shall be reported as zero.
            </pre>
            <hr>
        </div>
    </section>
    <section>
        <h3 class="section-title">CDC ACM</h3>
        <div class="section_content">
            <h3>CDC控制接口</h3>
            <p>接口编号在<code>wIndex & 0xff</code></p>
            <table border="1">
                <thead>
                    <th>bRequest</th>
                    <th>wValue</th>
                    <th>做什么</th>
                </thead>
                <tbody>
                    <tr>
                        <td>GET_LINE_CODING(0x21)</td>
                        <td></td>
                        <td>
                            返回一个7字节的信息
                            <pre>
uint32_t baud_rate;
uint8_t stop_bits; // 停止位
uint8_t parity;    // 奇偶校验
uint8_t data_bits; // 数据位
                            </pre>
                        </td>
                    </tr>
                    <tr>
                        <td>SET_LINE_CODING(0x20)</td>
                        <td></td>
                        <td>
                            设置一个7字节的信息，看上面
                        </td>
                    </tr>
                    <tr>
                        <td>CDC_SET_LINE_CTLSTE(0x22)</td>
                        <td>
                            <pre>
bit0: DTR
bit1: RTS
                            </pre>
                        </td>
                        <td>只有DTR为1时你可以发数据给上位机，否则主机会拒绝你的数据并产生Stall</td>
                    </tr>
                    <tr>
                        <td>SEND_ENCAPSULATED_COMMAND(0x00)</td>
                        <td></td>
                        <td><a href="https://www.usbzh.com/article/detail-1503.html">不知道干嘛的，反正不stall</a></td>
                    </tr>
                    <tr>
                        <td>GET_ENCAPSULATED_RESPONSE(0x01)</td>
                        <td></td>
                        <td><a href="https://www.usbzh.com/article/detail-1504.html">不知道干嘛的，反正不stall</a></td>
                    </tr>
                    <tr>
                        <td>SET_COMM_FEATURE(0x02)</td>
                        <td></td>
                        <td><a href="https://www.usbzh.com/article/detail-1505.html">不知道干嘛的，反正不stall</a></td>
                    </tr>
                    <tr>
                        <td>GET_COMM_FEATURE(0x03)</td>
                        <td></td>
                        <td><a href="https://www.usbzh.com/article/detail-1506.html">不知道干嘛的，反正不stall</a></td>
                    </tr>
                    <tr>
                        <td>CLEAR_COMM_FEATURE(0x04)</td>
                        <td></td>
                        <td><a href="https://www.usbzh.com/article/detail-1507.html">不知道干嘛的，反正不stall</a></td>
                    </tr>
                    <tr>
                        <td>SEND_BREAK(0x23)</td>
                        <td></td>
                        <td><a href="https://www.usbzh.com/article/detail-1517.html">不知道干嘛的，反正不stall</a></td>
                    </tr>
                </tbody>
            </table>
            <hr>
        </div>
    </section>
    <section>
        <h3 class="section-title">HID</h3>
        <div class="section_content">
            <p>接口编号在<code>wIndex & 0xff</code></p>
            <table border="1">
                <thead>
                    <th>bRequest</th>
                    <th>wValue</th>
                    <th>做什么</th>
                </thead>
                <tbody>
                    <tr>
                        <td>SET_REPORT(0x09)</td>
                        <td rowspan="2">高8位：报告类型<br>低8位：报告id</td>
                        <td>当hid接口没有中断接收端点时，主机会从这里发送hid报告内容给你</td>
                    </tr>
                    <tr>
                        <td>GET_REPORT(0x01)</td>
                        <td>
                            当hid接口没有中断端点时，可能会从这里接受hid报告内容
                        </td>
                    </tr>
                    <tr>
                        <td>GET_IDLE(0x02)</td>
                        <td>低8位：报告id</td>
                        <td>读取某个报告的idle速率</td>
                    </tr>
                    <tr>
                        <td>SET_IDLE(0x0a)</td>
                        <td></td>
                        <td>53页，有点复杂</td>
                    </tr>
                    <tr>
                        <td>SET_PROTOCOL(0x0b)</td>
                        <td></td>
                        <td rowspan="2">和boot模式有关</td>
                    </tr>
                    <tr>
                        <td>GET_PROTOCOL(0x03)</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>GET_DESCRIPTOR(0x06)</td>
                        <td rowspan="2">
                            高8位：类型(0x21,0x22,0x23)<br>
                            低8位：非物理描述符为0，是的话0是发物理描述符的数量，物理描述符索引从1开始
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>SET_DESCRIPTOR(0x07)</td>
                        <td>可选</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>
    <section>
        <h3 class="section-title">评论</h3>
        <div class="section_content">
            <script src="https://utteranc.es/client.js"
                repo="a5632645/a5632645.github.io"
                issue-term="pathname"
                theme="github-light"
                crossorigin="anonymous"
                async>
            </script>
        </div>
    </section>
    <script src="../../main.js"></script>
    <script>
        let timer = setInterval(function() {
            // window.scrollTo(0, document.body.scrollHeight);
        }, 100);
    </script>
</body>
</html>
